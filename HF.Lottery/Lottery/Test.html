<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title></title>
    <script type="text/javascript" src="js/jquery-1.7.2-min.js"></script>
    <!--<script type="text/javascript" src="js/animateBackground-plugin.js"></script>-->
    <script type="text/javascript" src="js/easing.js"></script>
    <script type="text/javascript" src="employee.js"></script>
    <script type="text/javascript" src="Scripts/JSLINQ.js"></script>
    <script type="text/javascript" src="Scripts/datajs-1.1.3.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
            border: 0 none;
            padding: 0;
            /*text-align:center;*/
        }

        #total {
            font-size: 20px;
            margin-top: -690px;
            position: absolute;
            width: 524px;
            margin-left: 83px;
            top: 100%;
        }

            #total .t_num, #total span {
                display: inline-block;
                line-height: 13px;
                margin: auto 4px 0 4px;
                /*border: 1px solid rgb(223, 216, 216);*/
            }

                #total .t_num i, #total span i {
                    width:  77.3px;
                    height: 50px;
                    display: inline-block;
                    background: url(images/num1.png) repeat-y;
                    background-position: 0 0;
                    text-indent: -999em;
                    margin-top: 6px;
                    margin-bottom:6px;
                }

        #audio {
            display: none;
        }

        #resultprize {
            height: 500px;
            overflow-y: scroll;
        }

        .contain {
            position: absolute;
            z-index: 9;
            display: none;
        }

        .swapper {
            position: absolute;
            /*text-align:center;*/
            top: 50%;
            left: 50%;
            margin-left: -340px;
            margin-top: -384px;
            height: 768px;
            overflow: hidden;
        }

        .hand {
            z-index: 9;
            margin-bottom: 300px;
            margin-left: -78px;
        }
         #audio {
            display: none;
        }

        #resultprize {
            height: 500px;
            overflow-y: scroll;
        }
    </style>
</head>
<body>
    <img border=0 id=smallslot src="images/bg.png" style="position:absolute; z-index:0" align=left onload="this.width = screen.width; this.height = window.screen.height;">

    <div class="swapper">

        <img border=0 src="images/machine.png" style="z-index:1;" width="680" height="768" />
        <img style="-webkit-user-select: none" src="images/hand.gif" class="hand">
        <div id="total">
            <span class="t_num">
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
            </span>
            <span class="t_num">
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
            </span>
            <span class="t_num">
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
            </span>
            <span class="t_num">
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
            </span>
            <span class="t_num">
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
            </span>
            <span class="t_num">
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
            </span>
            <span class="t_num">
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
            </span>
            <span class="t_num">
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
            </span>
            <span class="t_num">
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
            </span>
            <span class="t_num">
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
            </span>
        </div>

    </div>


    <div class="contain">
        <div style="display:none"><input type="button" id="start" value="开始" /></div>
        <div class="right">
            <select id="prizeList">
                <option value="0">一等奖</option>
                <option value="1">二等奖</option>
                <option value="2">三等奖</option>
                <option value="3">四等奖</option>
                <option value="4">五等奖</option>
                <option value="5">六等奖</option>
                <option value="6">七等奖</option>
                <option value="7">八等奖</option>
                <option value="8">九等奖</option>
                <option value="9">十等奖</option>
                <option value="10">嘉奖</option>
            </select>
            <!--<input type="button" id="reset" value="重置" />-->
            <div id="resultprize">
                <div>
                    共<span></span>名
                </div>
            </div>
        </div>
    </div>
    <div id="copy">
        <div class="div_num">
            <span class="t_num">
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
                <i style="background-position: 0px 0px;"></i>
            </span>
        </div>
    </div>
    <div id="audio">
        <audio id="roll" src="Content/musicOfRolling.mp3" loop="loop" controls="controls">
            Your browser does not support the audio element.
        </audio>
        <audio id="draw" src="Content/musicOfDraw.mp3" controls="controls">
            Your browser does not support the audio element.
        </audio>
    </div>
    <script>
        var store = datajs.createStore('hfLottery');
        var emplyees = [];
        //var prize = [];
        function numRand() {
            var x = currentPersons.length - 1; //上限
            var y = 0000; //下限
            var rand = parseInt(Math.random() * (x - y + 1) + y);
            return rand;
        }
        Array.prototype.remove = function (indexNum) {
            if (isNaN(indexNum) || indexNum > this.length) {
                return false;
            }
            this.splice(indexNum, 1);
        }
        String.prototype.pedLeft = function (char, len) {
            var c = char[0];
            if (this.length >= len) return this;
            var txt = '';
            var l = len - this.length;
            for (var i = 0; i < l; i++) {
                txt += c;
            }

            return txt + this;
        };
        var currentPrize = prize[0];
        var currentPersons = [];
        var prizedPerson = [];
        function addPrize(index) {
            var person = currentPersons[index];
            currentPrize.persons.push(currentPersons[index]);
            ////删除
            //currentPersons.remove(index);
            //var find = [];
            //for (var i = 0; i < emplyees.length; i++)
            //{
            //    if (emplyees[i].id == undefined || person.id == undefined)
            //    {
            //        console.log(i);
            //        console.log(emplyees[i]);
            //        console.log(person);
            //    }
            //    if (emplyees[i].id == person.id)
            //    {
            //        find.push(i);
            //        //emplyees.remove(i);
            //        //break;
            //    }
            //}

            //for (var i = 0; i < find.length; i++) {
            //    emplyees.remove(i);
            //}
            prizedPerson.push(person);
            $('#resultprize').append('<div>工号:<span>' + person.id + '</span>姓名:<span>' + person.name + '</span></div>')
            setTimeout(function () {
                try {
                    store.addOrUpdate('prize', prize);
                    store.addOrUpdate('emplyees', emplyees);
                }
                catch (e) { }
            }, 1);
        }

        $(document).ready(function () {
            var isStart = false;
            var canBegin = true;
            var u = 500;
            setInterval(function () {
                store.read('start', function (key, value) {
                    if (value == true) {
                        store.addOrUpdate('start', false);
                        changePrize(true);
                    }
                })
            }, 100);
            // LoadCurrentPersion();//加载默认开始奖项的候选人
            //changePrize();//加载奖项
            store.read('prize', function (key, value) {
                console.log(value);
                if (value != null && value.length > 0) {
                    value.forEach(function (item, index) {
                        if (prize.length >= index) {
                            prize[index].persons = item.persons;
                            prize[index].num = item.num;
                            prize[index].zone = item.zone;
                        }
                    });
                }
                store.read('prizedPerson', function (key, value) {
                    if (value == undefined || value == '') {
                        prizedPerson = [];
                    }
                    else {
                        prizedPerson = value;
                    }

                });
                store.read('employees', function (key, value) {
                    emplyees = value;
                    LoadCurrentPersion();
                    changePrize();//加载奖项

                });
            });
            function isPrized(id) {
                for (var i = 0; i < prizedPerson.length; i++) {
                    if (prizedPerson[i].id == id)
                    {
                        return true;
                    }

                    return false;
                }
            }
            $('#start').click(function () {
                if (!canBegin) return;
                if (currentPrize.persons.length >= currentPrize.num) return;
                if (isStart) {
                    canBegin = false;
                    $(this).val('开始');
                    document.getElementById('roll').pause();
                    document.getElementById('draw').play();
                    //生成 相应个
                    var okNum = [];
                    for (var ii = 0; ii < $('#total .t_num').length; ii++) {
                        var num = numRand();                        
                        okNum.push(currentPersons[num]);
                        currentPrize.persons.push(currentPersons[num]);
                        //var find = [];
                        for (var ij = 0; ij < emplyees.length; ij++)
                        {
                            if (emplyees[ij].id == undefined || currentPersons[num].id == undefined)
                            {
                                console.log(ij);
                                console.log(emplyees[ij]);
                                console.log(person);
                            }
                            if (emplyees[ij].id == currentPersons[num].id)
                            {
                                emplyees.remove(ij);
                                break;
                            }
                        }
                        currentPersons.remove(num);
                    }
                    
                    $('#total .t_num').each(function (i) {
                        
                        var result = okNum[i].id.toString().pedLeft('0', 6);
                        console.log(result);
                        var num_arr = (result + '').split('');
                        //开始减速动画
                        $(this).children('i').each(function (index) {
                            var _num = $(this);

                            setTimeout(function () {
                                clearInterval(_num.data('ani'));
                                var px = _num.css('background-position-y').substring(0, _num.css('background-position-y').length - 2);
                                _num.animate({

                                    backgroundPositionY: (500 - num_arr[index] * 50) + (Math.round(px / u) + 1) * (index + 1) * u//(u * 60) - (u * num_arr[index])
                                }, {
                                    duration: 600 + index * 300,
                                    easing: "jswing",
                                    complete: function () {
                                        if (index == 5) {
                                            isStart = false;
                                            canBegin = true;
                                            //addPrize(num);
                                        }
                                    }
                                });
                            }, index * 300);
                        })


                        if (i == ($('#total .t_num').length - 1))
                        {
                            setTimeout(function () {
                                try {
                                    store.addOrUpdate('prize', prize);
                                    store.addOrUpdate('emplyees', emplyees);
                                }
                                catch (e) { }
                            }, 1);
                        }

                    });
                }
                else {
                    isStart = true;
                    $(this).val('停止');
                    //重新渲染
                    var max = currentPrize.num - currentPrize.persons.length;
                    max = max > 10 ? 10 : max;
                    for (var i = 0; i < max; i++) {
                        $('#total span').eq(i).addClass('t_num').children().css("background-position", "0px 0px");
                    }
                    for (var i = currentPrize.num - currentPrize.persons.length; i < 10; i++) {
                        $('#total span').eq(i).removeClass('t_num').children().css("background-position", "0px 0px");
                    }
                    document.getElementById('roll').play();
                    $('#total .t_num i').each(function (index) {
                        var targert = $(this);
                        var t = setInterval(function () {
                            var px = targert.css('background-position-y').substring(0, targert.css('background-position-y').length - 2);
                            if (px == "" || px == 0) { px = index * 25 + index; };
                            targert.css('background-position-y', (parseInt(px) + 2) + "px");
                        }, 1);
                        targert.data('ani', t);
                    });

                }
            });
            function LoadCurrentPersion() {
                if (currentPrize.id == 11) {
                    currentPersons = emplyees;
                    return;
                }
                var c = JSLINQ(emplyees).Where(function (item) {
                    if (item == null || item.age == null)
                        return false;
                    return item.age >= currentPrize.zone.min && item.age <= currentPrize.zone.max;
                })
                currentPersons = c.items;
            }

            function changePrize(auto) {
                store.read('currentprize', function (key, value) {
                    var index = value;
                    if (index == null || index < 0)
                        index = 0;

                    //if (currentPrize.id != prize[index].id) {
                        //$('.t_num i').each(function (index) {
                        //    clearInterval($(this).data('ani'));
                        //});
                        ////isStart = false;
                        ////canBegin = true;
                    //$('#start').val('开始');
                    currentPrize = prize[index];
                        LoadCurrentPersion();
                        
                    //}



                    if (auto == true) {
                        $('#start').click();
                    }
                })
            };           

        });
    </script>

</body>
</html>
